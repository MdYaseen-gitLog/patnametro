<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Patna Metro ‚Äî Accurate Live Loop</title>
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: Inter, system-ui;
            background: #081222;
            color: #eaf2ff
        }

        .container {
            max-width: 900px;
            margin: auto
        }

        h1 {
            font-size: 18px;
            margin: 0 0 8px
        }

        .line-wrap {
            background: rgba(255, 255, 255, 0.03);
            padding: 16px;
            border-radius: 12px;
            margin-top: 10px
        }

        .station {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin: 10px 0
        }

        .name {
            width: 120px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 20px
        }

        .line {
            flex: 1;
            height: 8px;
            background: linear-gradient(90deg, #0b64ff, #3c14b4);
            border-radius: 4px;
            position: relative
        }

        .dot {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff
        }

        .badge {
            min-width: 150px;
            padding: 8px 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            margin-left: 4px;
            margin-top: 20px;
            margin-bottom: 20px
        }

        .green {
            background: #c9ffd9;
            color: #064022;
            box-shadow: 0 0 12px rgba(0, 255, 100, .3)
        }
        /* .green {
            background: #c9ffd9;
            color: #064022;
        } */

        .green-glow {
            background: #c9ffd9;
            color: #064022;
            border: 2px solid #00ff88;
            box-shadow: 0 0 15px 4px rgba(0, 255, 100, 0.5);
            animation: glowPulse 1.5s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0% {
                box-shadow: 0 0 5px 2px rgba(0, 255, 100, 0.4);
            }

            50% {
                box-shadow: 0 0 15px 6px rgba(0, 255, 100, 0.6);
            }

            100% {
                box-shadow: 0 0 5px 2px rgba(0, 255, 100, 0.4);
            }
        }




        .red {
            background: #ffcfcf;
            color: #5a0a0a;
            box-shadow: 0 0 12px rgba(255, 80, 80, .3)
        }

        .yellow {
            background: #fff3c1;
            color: #5a3d00;
            box-shadow: 0 0 12px rgba(255, 200, 0, .3)
        }

        .muted {
            background: rgba(255, 255, 255, .05);
            color: #aaa
        }

        h1 {
            text-align: center;
        }

        #clock {
            width: 74px;
            height: 74px;
            border-radius: 50%;
            background: #ffffff;
            /* White background */
            color: #000000;
            /* Black text */
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px auto;
            text-align: center;
            white-space: nowrap;
            user-select: none;
            box-shadow: 0 0 12px rgba(0, 128, 255, 0.6);
            /* Glowing blue border */
            transition: box-shadow 0.3s ease;
        }

        #clock:hover {
            box-shadow: 0 0 20px rgba(0, 128, 255, 0.8);
        }





        @media (max-width: 600px) {
            .station {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .line {
                flex: none;
                /* ‚Üê IMPORTANT: override flex:1 here */
                width: 8px;
                height: 100px;
                background: linear-gradient(to bottom, #0b64ff, #3c14b4);
                /* vertical gradient */
                margin: 8px 0;
            }

            .dot {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .badge {
                margin-top: 12px;
                margin-left: 0;
            }

            .name {
                width: auto;
                margin-bottom: 8px;
            }

            #clock {
                flex-direction: column;
                align-items: center;
                text-align: center;
                font-size: 10px
            }
            a{
                color: white;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Patna Metro Live Status</h1>
        <p id="clock" style="text-align: center;"></p>
        <div class="line-wrap" id="list"></div>

    </div>

    <script>
        const STATIONS = ["New ISBT", "Zero Mile", "Bhootnath"];
        // travel time map (in minutes)
        const travelMap = [
            { from: "New ISBT", to: "Zero Mile", minutes: 5 },
            { from: "Zero Mile", to: "Bhootnath", minutes: 5 },
            { from: "Bhootnath", to: "Zero Mile", minutes: 5 },
            { from: "Zero Mile", to: "New ISBT", minutes: 5 }
        ];

        const TRAVEL_MIN = 5, CYCLE_MIN = 20, START = "08:00", END = "23:00";
        const ARRIVE_S = 15, DEPART_S = 30;

        function toDate(hm) { const [h, m] = hm.split(":").map(Number); const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate(), h, m, 0, 0); }
        function addMin(d, m) { return new Date(d.getTime() + m * 60000); }
        function addSec(d, s) { return new Date(d.getTime() + s * 1000); }
        function fmt(t) { return t.toLocaleTimeString(); }
        function hhmmss(ms) { if (ms < 0) ms = 0; const s = Math.floor(ms / 1000), m = Math.floor(s / 60) % 60, h = Math.floor(s / 3600); return (h > 0 ? h.toString().padStart(2, "0") + ":" : "") + String(m).padStart(2, "0") + ":" + String(s % 60).padStart(2, "0"); }

        function buildLoopTimes() {
            const map = {};
            STATIONS.forEach(s => map[s] = []);
            let start = toDate(START), end = toDate(END);

            while (start <= end) {
                let t = new Date(start);
                // step through the travel map sequence
                for (const seg of travelMap) {
                    // record arrival at each destination
                    if (!map[seg.to]) map[seg.to] = [];
                    t = addMin(t, seg.minutes);
                    map[seg.to].push(new Date(t));
                }
                // repeat next loop cycle (sum of all minutes)
                const total = travelMap.reduce((a, b) => a + b.minutes, 0);
                start = addMin(start, total);
            }
            return map;
        }
        const times = buildLoopTimes();

        const wrap = document.getElementById("list");
        STATIONS.forEach(s => {
            const div = document.createElement("div");
            div.className = "station";
            div.innerHTML = `<div class="name">${s}</div><div class="line"><div class="dot"></div></div><div class="badge muted" id="b_${s.replace(/\s/g, "_")}">--</div>`;
            wrap.appendChild(div);
        });

        function update() {
            const now = new Date();
            document.getElementById("clock").textContent = fmt(now);

            const loggedArrivals = {};
            const nextArrivals = [];

            // First pass: gather prev/next times per station
            STATIONS.forEach(s => {
                const arr = times[s];
                let prev = null, next = null;

                for (let i = arr.length - 1; i >= 0; i--) {
                    if (arr[i] <= now) { prev = arr[i]; break; }
                }
                for (const t of arr) {
                    if (t >= now) { next = t; break; }
                }

                nextArrivals.push({ station: s, prev, next });
            });

            // üîç Find the station with the nearest next train (minimum countdown)
            const activeArrivals = nextArrivals.filter(e => e.next);
            let minStation = null;

            if (activeArrivals.length > 0) {
                minStation = activeArrivals.reduce((a, b) =>
                    (a.next - now < b.next - now ? a : b)
                ).station;
            }

            // Second pass: render each station's badge
            nextArrivals.forEach(({ station: s, prev, next }) => {
                const el = document.getElementById("b_" + s.replace(/\s/g, "_"));
                let text = "";
                let cls = "muted";

                if (prev && now < addSec(prev, ARRIVE_S)) {
                    cls = "green";
                    text = `Arrived<br>${fmt(prev)}`;

                    // Log once per arrival
                    const key = `${s}_${prev.getTime()}`;
                    if (!loggedArrivals[key]) {
                        console.log(`Arrived at ${s} ‚Äî ${fmt(prev)}`);
                        loggedArrivals[key] = true;
                    }

                } else if (prev && now < addSec(prev, ARRIVE_S + DEPART_S)) {
                    cls = "red";
                    text = `Departed<br>${fmt(prev)}`;

                } else if (next) {
                    const countdown = hhmmss(next - now);
                    const arrivalTime = next.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // ‚úÖ Highlight only the soonest train in green
                    cls = (s === minStation) ? "green-glow" : "yellow";


                    text = `Next Train at <b>${arrivalTime}</b><br>in ${countdown}`;
                    console.log(`Next Train at ${s} ‚Äî in ${countdown} (at ${arrivalTime})`);

                    localStorage.setItem(`nextTrain_${s.replace(/\s/g, "_")}`, next.toISOString());

                } else {
                    text = "Service Closed";
                }

                el.className = "badge " + cls;
                el.innerHTML = text;
            });
        }

        update(); setInterval(update, 700);
    </script>
    <a href="nexttrain2.html">Next train</a><br>
    <a href="passenger_status.html">Passenger Status-GPS</a><br>
    <a href="multipleStatus.html">MultipleStatus-moved</a><br>
    <a href="statusDelay.html">GPS Delay</a><br>
 
</body>

</html>